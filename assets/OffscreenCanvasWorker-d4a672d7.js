var tt=Object.defineProperty;var et=(a,r,c)=>r in a?tt(a,r,{enumerable:!0,configurable:!0,writable:!0,value:c}):a[r]=c;var p=(a,r,c)=>(et(a,typeof r!="symbol"?r+"":r,c),c);(function(){"use strict";var a=(t=>(t.PLANE="plane",t.CYLINDER="cylinder",t))(a||{}),r=typeof global=="object"&&global&&global.Object===Object&&global,c=r,E=typeof self=="object"&&self&&self.Object===Object&&self,L=c||E||Function("return this")(),N=L,P=N.Symbol,O=P,_=Object.prototype,G=_.hasOwnProperty,$=_.toString,m=O?O.toStringTag:void 0;function k(t){var e=G.call(t,m),s=t[m];try{t[m]=void 0;var n=!0}catch(i){}var u=$.call(t);return n&&(e?t[m]=s:delete t[m]),u}var A=Object.prototype,D=A.toString;function R(t){return D.call(t)}var W="[object Null]",Y="[object Undefined]",M=O?O.toStringTag:void 0;function H(t){return t==null?t===void 0?Y:W:M&&M in Object(t)?k(t):R(t)}function I(t){return t!=null&&typeof t=="object"}var B="[object Number]";function U(t){return typeof t=="number"||I(t)&&H(t)==B}class q{constructor(e){p(this,"_left");p(this,"_top");p(this,"offscreenCanvas");p(this,"ctx");p(this,"options");const s=e.stageWidth,n=e.stageHeight;this._left=(e.width-s)/2,this._top=(e.height-n)/2,this.options=e,this.initOffscreen(e)}initOffscreen(e){e.useOffscreen&&(this.offscreenCanvas=new OffscreenCanvas(e.width||400,e.height||300),this.ctx=this.offscreenCanvas.getContext("2d"))}drawLine(e){var u;const s=(u=this.options.machineOptions)==null?void 0:u.S,n=this.ctx;n.save(),n.lineWidth=this.options.strokeWidth||1,e.forEach((i,l)=>{var g;if(n.beginPath(),l!==0){let h=(g=this.options.strokeStyle)==null?void 0:g.split(",");h[h.length-1]=i.s/s+")",h=h.join(","),n.strokeStyle=h,n.moveTo(e[l-1].x+this._left,e[l-1].y+this._top),n.lineTo(i.x+this._left,i.y+this._top)}n.stroke()}),n.restore()}}function F(){const t=+new Date;return()=>(+new Date-t)/1e3+"ç§’"}let o=null,T;self.onmessage=t=>{o=t.data,o.gcode&&K(o.gcode),o.offscreenCanvas&&X(o)};let S,f;function K(t){T=F();const e=2e3,s=100*60;let n=[];const u=/G[01].*?\n/g;if(n=t.match(u),!n){self.postMessage(null);return}f=[];let i={x:0,y:0,s:e,f:s},l=0,g=null;const h=o.mode===a.CYLINDER,Z=/[A-Z]+[+-]*\d+(\.\d+)?/g,j={x:0,y:0,s:0,f:0,u:0};n.forEach(b=>{b=b.replace(/\s/g,"");const z=b.startsWith("G0");b=b.replace(/G[01]/,"");const x=b.match(Z);x&&x.length>0&&x.forEach(w=>{const C=w.charAt(0).toLocaleLowerCase();j[C]=Number(w.substring(1))});let{x:y,y:v}=j;const{s:J,f:Q,u:V}=j;h&&!g&&U(v)&&(g=j.y),g&&(v=y,y=V/o.U_RATE,y=o.stageHeight-g+y);const d={x:y,y:v,s:J,f:Q};if(z)f[f.length]=[d];else{f[f.length-1].push(d);const w=Math.abs((d.x||0)-i.x),C=Math.abs((d.y||0)-i.y);l+=Math.sqrt(Math.pow(w,2)+Math.pow(C,2))/((d.f||s)/60)}i=d}),o.useOffscreen?self.postMessage({showModal:!0,duration:l}):self.postMessage({showModal:!0,duration:l,pictures:f})}function X(t){S=new q(t.options),f.forEach(s=>{S.drawLine(s)});const e=S.offscreenCanvas.transferToImageBitmap();self.postMessage({drawOK:!0,imageBitmap:e,time:T()},[e]),T=null}})();
