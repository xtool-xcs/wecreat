import{_ as be}from"./equ-img-d9c9b100.js";import{r as a,m as Se,L as we,g as he,G as Ie,O as A,d as qe,i as Ee,Q as b,c as y,b as I,j as p,u as i,n as Pe,t as S,k as P,e as Z,w as J,x as M,v as ee,l as We,a as V,o as C,F as Ae,f as Ne,p as Le,q as $e,_ as De}from"./index-e43f4e63.js";import{_ as Oe}from"./bottomPopSheet.vue_vue_type_style_index_0_lang-1c011284.js";import{u as ke,c as xe}from"./device-1f3f345b.js";import{s}from"./opencv-49a7e8f2.js";import{s as Be}from"./function-call-76f75aad.js";import"./index-affcdb37.js";import"./isObject-93378927.js";const Te=""+new URL("scaning-outside-31c6fa95.png",import.meta.url).href,Je=""+new URL("scan-inner-fcc36e50.png",import.meta.url).href,Ue=""+new URL("close-equ-1a07c11e.png",import.meta.url).href,Re=""+new URL("mobile_in_hand-10700bef.png",import.meta.url).href,Fe=""+new URL("signal3-e93bb6b2.png",import.meta.url).href;function ze(){const n=window.innerHeight,h=a(""),r=a(!1),t=a("init"),N=ke();return{height:n,currentDeviceId:h,isShowWifiBox:r,deviceStore:N,connectStatus:t,handleJsonStr:$=>$?JSON.parse($):{},getInfo:async()=>{}}}function Me(n){const h=Se(),r=ke(),{t}=we(),N=20,L=20,d=a([]),$=a([]),q=a(0),D=a(0),W=a(!1),O=a(!1),x="mbtc";let m=null,c=null;const v=he(()=>{var o;return(o=r.deviceParams)==null?void 0:o.wlan0_ip}),u=a(!1),U=a(!1),w=a(!1),B=a(!1),R=a(!1),G=a([]),H=a(!1),k=a(!1),ne=he(()=>r.isConnectedDevice),T=a(!1),E=async()=>{v.value&&!ne.value&&F()},F=async()=>{n.connectStatus.value="httpConnecting",c=setInterval(()=>{D.value<L?D.value=D.value+1:te()},1e3),u.value=!0;const{code:o}=await r.getDeviceInfoAPI(v.value);W.value||(u.value=!1,o===1&&(s(t("device.blue.equConnSucc")),setTimeout(()=>{h.back()},1e3)))},Q=()=>{U.value=!1,W.value=!1,F()},le=async()=>{W.value=!0,U.value=!1,u.value=!1,await r.getDeviceInfoAPI(v.value,!0)},K=async()=>{if(w.value){_();return}const e=(await r.getNativeDeviceInfo()).networkType==="2";if(console.log(e,"----isWifi---"),!e){s(t("device.plsConnectWifi"));return}n.connectStatus.value="blueScaning",U.value=!1,d.value=[],H.value=!1,A("scan",{},l=>{if(l){const g=JSON.parse(l);g.code==="0"?g.bleAuthority==="0"?(s(t("device.blue.failedGetPermissions")),_()):g.bleState==="0"?(s(t("device.blue.noOpen")),_()):g.bleState==="2"&&K():(w.value=!0,m=setInterval(()=>{q.value<N?q.value=q.value+1:(w.value&&ce(),m&&clearInterval(m),m=null,q.value=0)},1e3))}})},te=()=>{c&&(clearInterval(c),D.value=0),u.value&&(U.value=!0,u.value=!1,n.connectStatus.value="httpConnectOverTime")},_=()=>{w.value=!1,n.connectStatus.value==="blueScaning"&&(n.connectStatus.value="init"),A("stopScan",{},o=>{console.log(o)}),m&&(clearInterval(m),m=null,q.value=0)},X=o=>{if(H.value)return;n.connectStatus.value="blueConnecting",u.value=!0,w.value=!1;const e={deviceId:o.deviceId};A("connect",e,l=>{if(l){const g=JSON.parse(l);g.bleAuthority==="0"?s(t("device.blue.failedGetPermissions")):g.bleState==="0"?s(t("device.blue.noOpen")):g.param==="0"&&s(t("device.blue.notFound"))}})},se=o=>{const e=n.handleJsonStr(o);e.deviceName.indexOf(x)>-1&&(d.value=ae(e),$.value=d.value.map(l=>({text:l.deviceName,value:l.deviceId})))},ae=o=>{let e=[];const l=d.value.findIndex(g=>g.deviceId===o.deviceId);if(l===-1)e=[...d.value,o];else{const g=xe(d.value);g[l].rssi=o.rssi,e=g}return e},ce=()=>{if(!d.value||d.value.length===0){w.value=!1,s(t("device.blue.emptyEquList")),_();return}m&&(clearInterval(m),m=null,q.value=0);let o=null;for(let e=0;e<d.value.length;e++)(e===0||Number(d.value[e].rssi)>Number(o.rssi))&&(o=d.value[e]);Math.abs(o.rssi)<=40?X(o):(O.value=!0,w.value=!1)},ue=({selectedValues:o})=>{if(O.value=!1,o&&o.length>0){const e=o[0];X({deviceId:e})}},re=async o=>{const e=n.handleJsonStr(o);if(n.distributNetworkIP.value=e.ip,console.log(n.isWifiConfigSuccessed.value,"-----isWifiConfigSuccessed---->>>",e.ip),n.isWifiConfigSuccessed.value){if(n.isWifiConfigSuccessed.value=!1,!e.ip){console.log("设备ip为空了"),n.connectStatus.value="blueConnected",s(t("device.dirtInterFailed"));return}console.log("配网成功,连接设备----->>>"),n.wifiConfigCallback&&n.wifiConfigCallback(),s(t("device.dirtInterSuccessCon"));try{u.value=!0;const{code:l}=await r.getDeviceInfoAPI(e.ip);console.log("info---->>>",l),u.value=!1,setTimeout(()=>{l===1?(s(t("device.blue.equConnSucc")),n.connectStatus.value="equConnected",n.distributNetworkIP.value="",setTimeout(()=>{h.back()},1e3)):(n.connectStatus.value="errorEqu",s(t("device.wifiConfigErrorTips")),console.log("连接失败------>>>>>"))},1e3)}catch(l){u.value=!1,console.log("---连接异常了"),n.connectStatus.value="blueConnected",s(t("device.blue.connError"))}}},de=o=>{const e=n.handleJsonStr(o);w.value=!1,u.value=!1,console.log(e.deviceState,"------蓝牙连接状态----->>>>"),e.deviceState==="1"?(H.value=!0,n.connectStatus.value="blueConnected",n.currentDeviceId.value=e.deviceId,T.value=!0,s(t("device.blue.connectSuccess")),_(),n.handleScanWifi()):(n.connectStatus.value="init",s(t("device.blue.disconnected")),n.wifiConfigCallback&&n.wifiConfigCallback())},ve=o=>{if(o){const e=JSON.parse(o);e.bleState||e.bleAuthority?e.bleState==="0"||e.bleAuthority==="0"?(n.connectStatus.value="init",_(),e.bleAuthority==="0"?s(t("device.blue.failedGetPermissions")):e.bleState==="0"&&s(t("device.blue.noOpen"))):w.value=!1:e.networkAuthority==="0"||e.wifiAuthority==="0"?n.connectStatus.value="init":e.albumAuthority==="0"&&(n.connectStatus.value="init",s(t("device.blue.openAlbumPermis")))}},fe=()=>{if(B.value){ie();return}B.value=!0,n.connectStatus.value="euqScaning",A("ipScan",{},o=>{if(o){const e=JSON.parse(o);console.log("ipScan----回调----->>>>>",e),e.code==="0"&&(B.value=!1,G.value=[],R.value=!1,s(t("device.checkWifi")))}})},ie=()=>{A("ipStopScan"),B.value=!1},oe=o=>{if(B.value=!1,o){const e=JSON.parse(o);if(e.code==="1"){const l=JSON.parse(e.list),g=l==null?void 0:l.map(z=>typeof z=="string"?JSON.parse(z):z);G.value=g,R.value=!0}else e.localNetworkAuthority==="0"?s(t("device.noLocalNetAut")):s(t("device.blue.noEqu")),G.value=[],R.value=!1}},pe=async o=>{k.value=!0,n.connectStatus.value="equConnecting";try{const{code:e}=await r.getDeviceInfoAPI(o.wlan0_ip);k.value=!1,e===1?(s(t("device.blue.equConnSucc")),R.value=!1,setTimeout(()=>{h.back()},500)):s(t("device.blue.connError"))}catch(e){k.value=!1}};return Ie(()=>{_(),ie(),m&&clearInterval(m),c&&clearInterval(c)}),{blueListOptions:$,deviceIP:v,isConnecting:u,isOverTimer:U,isAddingEqu:w,isShowWifiBox:T,isScaningEqu:B,showEquPicker:R,equList:G,isShowConnectEqcLoading:k,showBluePicker:O,handleScan:K,handleConnect:X,scanCallback:se,deviceDataCallback:re,stateUpdateCallback:de,initPage:E,connectAgain:Q,permissionResultCallback:ve,ipScanCallback:oe,handleScanEqu:fe,onConfirmEqu:pe,handleCancelConnect:le,chooseBlueConfirm:ue}}function Ve(n){const{t:h}=we(),r=a(""),t=a(""),N=a(!1),L=a([]),d=a(!1),$=()=>{r.value="",t.value="",N.value=!1,L.value=[],d.value=!1},q=()=>{L.value=[],A("wifiScan",{},c=>{const v=n.handleJsonStr(c);v.code!=="1"&&v.wifiAuthority&&v.wifiAuthority==="0"&&s(h("device.openDeviceLoc"))})},D=({selectedValues:c})=>{c&&c.length>0&&(r.value=c[0],N.value=!1)},W=()=>{L.value.findIndex(u=>u.ssid===r.value)===-1?Be({title:h("common.tip"),message:h("device.confirm2_4G"),confirmButtonText:h("common.confirm"),cancelButtonText:h("device.switchWifi")}).then(()=>{O()}).catch(()=>{A("appSetting")}):O()},O=()=>{if(n.connectStatus.value==="wifiConnecting"||n.connectStatus.value==="equConnecting")return;if(!t.value){s(h("login.posswordPla"));return}const c={ssid:r.value,pwd:t.value,deviceId:n.currentDeviceId.value};n.connectStatus.value="wifiConnecting",A("wifiConfig",c,async v=>{const u=n.handleJsonStr(v);if(console.log("wifiConfig--->>>",u),u.code==="1"){x();return}u.param==="0"?(n.connectStatus.value="blueConnected",s(h("device.wifiConfigErrorTips"))):u.deviceState==="0"&&(n.connectStatus.value="blueConnected",s(h("device.blue.disconnected")),n.wifiConfigCallback&&n.wifiConfigCallback())})},x=()=>{setTimeout(()=>{d.value=!0,console.log("-----wifi配网成功分割线-----------"),A("readIpAfterWifiConfig",{deviceId:n.currentDeviceId.value})},3e3)};return{ssid:r,pwd:t,showWifiPicker:N,wifiList:L,isWifiConfigSuccessed:d,handleScanWifi:q,handleConfirmWifiConnect:W,wifiScanCallback:c=>{const v=n.handleJsonStr(c);console.log(v,"=========wifi列表");const u=v.current;r.value=u.ssid.replace(/["]/g,"")},chooseWifiConfirm:D,handleClear:$}}const j=n=>(Le("data-v-6704cdfd"),n=n(),$e(),n),Ge={key:0,class:"scaning-img-box"},He=j(()=>p("img",{src:Te,alt:"",class:"scaning-outside",draggable:"false"},null,-1)),je={key:0,class:"over-time-word"},Qe={key:2,class:"connecting-word"},Ke={key:3,class:"connect-ip"},Xe={key:1,class:"closeque-img-box"},Ye=j(()=>p("img",{src:Ue,alt:"",class:"close-equ-img",draggable:"false"},null,-1)),Ze=j(()=>p("img",{src:Re,alt:"",class:"hand-mobile-img",draggable:"false"},null,-1)),en=j(()=>p("img",{src:Fe,alt:"",class:"signal-img",draggable:"false"},null,-1)),nn=[Ye,Ze,en],on={class:"bottom-btn"},ln={key:0,class:"connect-wifi-content"},tn=j(()=>p("div",{class:"device-img-box"},[p("img",{src:be,alt:"",class:"device-img",draggable:"false"})],-1)),sn={class:"device-name"},an={class:"login-wifi-content"},cn={key:0,class:"flexCenter"},un={key:1,class:"flexCenter"},rn={key:2},dn={class:"loading-content"},vn={class:"equ-list-pop"},fn={class:"title"},pn=["onClick"],mn=j(()=>p("img",{src:be,alt:"",class:"equ-list-img",draggable:"false"},null,-1)),gn={class:"equ-infos"},Cn={class:"infos"},hn={class:"infos"},bn=qe({__name:"index",setup(n){const h=Se(),r=a(!1),t=a(""),N=()=>{v.value&&v.value.length>0&&(c.value=!0)},L=()=>{r.value=!r.value},d=()=>{E.value=!1,x.value="",m.value=""},{height:$,currentDeviceId:q,deviceStore:D,connectStatus:W,handleJsonStr:O}=ze(),{ssid:x,pwd:m,showWifiPicker:c,wifiList:v,isWifiConfigSuccessed:u,handleScanWifi:U,handleConfirmWifiConnect:w,wifiScanCallback:B,chooseWifiConfirm:R,handleClear:G}=Ve({deviceStore:D,currentDeviceId:q,connectStatus:W,handleJsonStr:O,wifiConfigCallback:d}),{deviceIP:H,isConnecting:k,isOverTimer:ne,isAddingEqu:T,isShowWifiBox:E,isScaningEqu:F,showEquPicker:Q,equList:le,isShowConnectEqcLoading:K,blueListOptions:te,showBluePicker:_,handleScan:X,handleScanEqu:se,scanCallback:ae,deviceDataCallback:ce,stateUpdateCallback:ue,initPage:re,connectAgain:de,permissionResultCallback:ve,ipScanCallback:fe,onConfirmEqu:ie,handleCancelConnect:oe,chooseBlueConfirm:pe}=Me({deviceStore:D,currentDeviceId:q,connectStatus:W,isWifiConfigSuccessed:u,distributNetworkIP:t,handleJsonStr:O,handleScanWifi:U,wifiConfigCallback:d}),o=()=>{E.value?(E.value=!1,G()):h.back()};return Ee(()=>{b("scan"),b("stopScan"),b("connect"),b("disconnect"),b("wifiConfig"),b("wifiScan"),b("ipScan"),b("ipStopScan"),b("wifiScanCallback",B),b("scanCallback",ae),b("deviceDataCallback",ce),b("deviceStateCallback",ue),b("permissionResultCallback",ve),b("ipScanCallback",fe),b("androidAppExitIntercept"),A("androidAppExitIntercept",{state:"1"}),b("androidPhysicalBackButtonClicked",()=>{o()}),re()}),(e,l)=>{const g=V("top-bar"),z=V("van-button"),Y=V("van-loading"),me=V("van-picker"),ge=V("van-popup"),Ce=V("van-field"),_e=V("van-overlay");return C(),y("div",{class:"bluetooth-page",style:We({height:"".concat(i($),"px")})},[I(g,{title:e.$t("device.connectEqu"),"left-text":"",autoBack:!1,onOnClickLeft:o},null,8,["title"]),p("div",null,[!i(T)&&!i(F)&&!i(E)?(C(),y("div",Ge,[He,p("img",{src:Je,alt:"",class:Pe(["scaning-inner",{isRotation:i(k)}]),draggable:"false"},null,2),i(ne)?(C(),y("span",je,S(e.$t("device.connectOvertime")),1)):P("",!0),i(ne)?(C(),Z(z,{key:1,class:"over-time-btn",color:"var(--backgroundColorMain)",round:"",onClick:i(de)},{default:J(()=>[M(S(e.$t("device.reconnect")),1)]),_:1},8,["onClick"])):P("",!0),i(k)?(C(),y("span",Qe,S(e.$t("device.connecting")),1)):P("",!0),i(k)&&(i(H)||t.value)?(C(),y("span",Ke,[M(" IP:"+S(t.value||i(H))+"  ",1),p("span",{style:{color:"var(--backgroundColorMain)"},onClick:l[0]||(l[0]=(...f)=>i(oe)&&i(oe)(...f))},S(e.$t("common.cancel")),1)])):P("",!0)])):P("",!0),i(T)||i(F)?(C(),y("div",Xe,nn)):P("",!0),p("div",on,[!i(E)&&!i(k)?(C(),Z(z,{key:0,class:"btns scanEqu",round:"",disabled:!(!i(E)&&!i(k)&&!i(T)),color:"var(--backgroundColorMain)",onClick:i(se)},{default:J(()=>[i(F)?(C(),Z(Y,{key:0,color:"white",type:"spinner",size:"16px"})):P("",!0),M("  "+S(e.$t("device.scanEqu")),1)]),_:1},8,["disabled","onClick"])):P("",!0),!i(E)&&!i(k)?(C(),Z(z,{key:1,class:"btns add",round:"",disabled:!(!i(E)&&!i(k)&&!i(F)),onClick:i(X)},{default:J(()=>[i(T)?(C(),Z(Y,{key:0,color:"#333",type:"spinner",size:"16px"})):P("",!0),M("  "+S(i(T)?e.$t("device.scaning"):e.$t("device.addNewEqu")),1)]),_:1},8,["disabled","onClick"])):P("",!0)])]),I(ge,{show:i(_),"onUpdate:show":l[2]||(l[2]=f=>ee(_)?_.value=f:null),round:"",position:"bottom",class:"blue-picker-pop"},{default:J(()=>[I(me,{"show-toolbar":"",columns:i(te),onCancel:l[1]||(l[1]=f=>_.value=!1),onConfirm:i(pe)},null,8,["columns","onConfirm"])]),_:1},8,["show"]),i(E)?(C(),y("div",ln,[tn,p("span",sn,S(e.$t("device.euqName")),1),p("div",an,[I(Ce,{modelValue:i(x),"onUpdate:modelValue":l[3]||(l[3]=f=>ee(x)?x.value=f:null),style:{width:"100%"},label:"Wi-Fi","right-icon":i(v)&&i(v).length>0?"arrow-down":"",readonly:!0,"label-width":"70",placeholder:e.$t("device.wifiAcount"),onClick:N},null,8,["modelValue","right-icon","placeholder"]),I(Ce,{modelValue:i(m),"onUpdate:modelValue":l[4]||(l[4]=f=>ee(m)?m.value=f:null),type:r.value?"text":"password",label:e.$t("device.password"),"label-width":"70","right-icon":r.value?"eye-o":"closed-eye",placeholder:e.$t("device.passwordPla"),onClickRightIcon:L},null,8,["modelValue","type","label","right-icon","placeholder"]),I(ge,{show:i(c),"onUpdate:show":l[6]||(l[6]=f=>ee(c)?c.value=f:null),round:"",position:"bottom"},{default:J(()=>[I(me,{"show-toolbar":"",columns:i(v),onCancel:l[5]||(l[5]=f=>c.value=!1),onConfirm:i(R)},null,8,["columns","onConfirm"])]),_:1},8,["show"]),p("span",{class:"connect-wifi-btn",onClick:l[7]||(l[7]=(...f)=>i(w)&&i(w)(...f))},[i(W)==="wifiConnecting"?(C(),y("span",cn,[I(Y,{color:"white",type:"spinner",size:"16px"}),M("  "+S(e.$t("device.wifi.connecting")),1)])):i(W)==="equConnecting"?(C(),y("span",un,[I(Y,{color:"white",type:"spinner",size:"16px"}),M("  "+S(e.$t("device.equConnecting")),1)])):(C(),y("span",rn,S(e.$t("device.connectEqu")),1))])])])):P("",!0),I(_e,{show:i(K),"class-name":"overlay-cover",onClick:l[8]||(l[8]=f=>K.value=!1)},{default:J(()=>[p("div",dn,[I(Y,{size:"24px",vertical:""},{default:J(()=>[M(S(e.$t("device.equConnecting")),1)]),_:1})])]),_:1},8,["show"]),I(Oe,{show:i(Q),"onUpdate:show":l[9]||(l[9]=f=>ee(Q)?Q.value=f:null),title:e.$t("device.equ")},{default:J(()=>[p("div",vn,[p("span",fn,S(e.$t("device.plaChooseEqu")),1),(C(!0),y(Ae,null,Ne(i(le),(f,ye)=>(C(),y("div",{key:ye,class:"equ-list-content",onClick:Sn=>i(ie)(f)},[mn,p("div",gn,[p("span",Cn,S(f.name),1),p("span",hn,S(f.wlan0_ip),1)])],8,pn))),128))])]),_:1},8,["show","title"])],4)}}});const Wn=De(bn,[["__scopeId","data-v-6704cdfd"]]);export{Wn as default};
